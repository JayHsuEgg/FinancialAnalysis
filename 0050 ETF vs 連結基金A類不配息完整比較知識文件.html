<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0050 ETF vs 連結基金比較計算器 - 改進版</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 0;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-group input.error {
            border-color: #e74c3c;
            background-color: #fdf2f2;
        }
        
        .input-hint {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
            display: none;
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
            position: relative;
        }
        
        .calculate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .calculate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-top: 30px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }
        
        .results.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateY(-2px);
        }
        
        .result-card h3 {
            color: #2c3e50;
            margin: 0 0 20px 0;
            font-size: 1.4em;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-wrap: break-word;
        }
        
        .comparison-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .comparison-table .winner {
            background: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        
        .highlight {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
        }
        
        .tax-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .tax-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        
        .tax-item h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .positive { color: #27ae60; font-weight: bold; }
        .negative { color: #e74c3c; font-weight: bold; }
        
        /* highlight 區塊內的 positive 文字使用更明顯的顏色 */
        .highlight .positive { color: #ffeb3b; font-weight: bold; }
        
        .calculation-step {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .calculation-step h4 {
            color: #2c3e50;
            margin: 0 0 15px 0;
        }
        
        .formula {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            border: 1px solid #bee5eb;
            line-height: 1.6;
            word-wrap: break-word;
            font-size: 13px;
        }
        
        .step-result {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
            line-height: 1.5;
        }
        
        .rules-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .rule-section {
            background: #f1f3f4;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #ddd;
        }
        
        .rule-section h4 {
            color: #2c3e50;
            margin: 0 0 20px 0;
            font-size: 1.2em;
        }
        
        .fee-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 13px;
        }
        
        .fee-table th, .fee-table td {
            padding: 10px 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .fee-table th {
            background: #e9ecef;
            font-weight: 600;
        }
        
        .update-notice {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
            font-size: 14px;
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .input-group {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .rules-container {
                grid-template-columns: 1fr;
            }
            
            .comparison-table {
                font-size: 12px;
            }
            
            .comparison-table th,
            .comparison-table td {
                padding: 8px;
            }
            
            .tax-grid {
                grid-template-columns: 1fr;
            }
            
            /* 重點比較區塊的響應式設計 */
            #calculationProcess .grid-2-cols,
            #taxCostsCalculation .grid-2-cols {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
            
            /* 折疊區塊響應式設計 */
            .calculation-section {
                margin: 10px 0;
            }
            
            .calculation-section-header h4 {
                font-size: 1.1em;
                padding-right: 20px;
            }
            
            .calculation-section-content {
                padding: 15px;
            }
        }
        
        @media (min-width: 769px) {
            .rules-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* 表格橫向滾動 */
        .table-container {
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .table-container table {
            min-width: 600px;
        }
        
        /* 折疊功能樣式 */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
            position: relative;
            padding-right: 30px;
        }
        
        .collapsible-header:hover {
            color: #3498db;
        }
        
        .collapse-icon {
            position: absolute;
            right: 0;
            transition: transform 0.3s ease;
            font-size: 0.8em;
        }
        
        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }
        
        .collapsible-content {
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }
        
        .calculation-section {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            margin: 20px 0;
            overflow: hidden;
            background: #ffffff;
        }
        
        .calculation-section-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px 20px;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
            position: relative;
            border-bottom: 1px solid #dee2e6;
        }
        
        .calculation-section-header:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
        }
        
        .calculation-section-header h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2em;
            padding-right: 30px;
        }
        
        .calculation-section-content {
            padding: 20px;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .calculation-section-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>0050 ETF vs 連結基金比較計算器</h1>
            <p>完整分析投資成本、稅務影響與最佳選擇建議 - 改進版</p>
        </div>
        
        <div class="content">
            <div class="input-section">
                <h3>投資參數設定</h3>
                <div class="error-message" id="errorMessage"></div>
                <div class="input-group">
                    <div class="form-group">
                        <label for="monthlyInvestment">每月投資金額 (元)</label>
                        <input type="number" id="monthlyInvestment" value="3000" min="1000" max="100000" step="100">
                        <div class="input-hint">建議範圍：1,000 - 100,000 元</div>
                    </div>
                    <div class="form-group">
                        <label for="investmentYears">投資期間 (年)</label>
                        <input type="number" id="investmentYears" value="10" min="1" max="30" step="1">
                        <div class="input-hint">範圍：1 - 30 年</div>
                    </div>
                    <div class="form-group">
                        <label for="annualReturn">預期年化報酬率 (%)</label>
                        <input type="number" id="annualReturn" value="8" min="0" max="20" step="0.1">
                        <div class="input-hint">範圍：0 - 20%，建議5-12%</div>
                    </div>
                    <div class="form-group">
                        <label for="dividendYield">年配息率 (%)</label>
                        <input type="number" id="dividendYield" value="2.5" min="0" max="10" step="0.1">
                        <div class="input-hint">範圍：0 - 10%</div>
                    </div>
                    <div class="form-group">
                        <label for="taxableRatio">54C課稅比例 (%)</label>
                        <input type="number" id="taxableRatio" value="33" min="0" max="100" step="1">
                        <div class="input-hint">範圍：0 - 100%</div>
                    </div>
                    <div class="form-group">
                        <label for="personalTaxRate">個人綜所稅率 (%)</label>
                        <select id="personalTaxRate">
                            <option value="5">5% (年所得56萬以下)</option>
                            <option value="12" selected>12% (年所得56-126萬)</option>
                            <option value="20">20% (年所得126-252萬)</option>
                            <option value="30">30% (年所得252-472萬)</option>
                            <option value="40">40% (年所得472萬以上)</option>
                        </select>
                    </div>
                </div>
                <button class="calculate-btn" id="calculateBtn" onclick="handleCalculation()">
                    <span class="loading-spinner" id="loadingSpinner"></span>
                    <span id="btnText">開始計算比較</span>
                </button>
                <div class="update-notice">
                    <strong>📅 數據更新：</strong>基金規模數據定期更新。0050規模：6,473.76億元，連結基金規模：240億元（2024年數據）
                </div>
            </div>

            <div class="results" id="results">
                <div class="result-card">
                    <h3 class="collapsible-header" onclick="toggleCollapse('feeRules')">
                        📋 費用結構規則說明 <span class="collapse-icon">▼</span>
                    </h3>
                    <div id="feeRules" class="collapsible-content"></div>
                </div>

                <div class="result-card">
                    <h3>🧮 內扣費用</h3>
                    <div id="calculationProcess"></div>
                </div>

                <div class="result-card">
                    <h3>💸 交易成本</h3>
                    <div id="transactionCostsCalculation"></div>
                </div>

                <div class="result-card">
                    <h3>🧾 稅務成本</h3>
                    <div id="taxCostsCalculation"></div>
                </div>

                <div class="result-card">
                    <h3>📊 總成本比較</h3>
                    <div id="totalComparison"></div>
                </div>

                <div class="result-card">
                    <h3>💡 投資建議</h3>
                    <div id="investmentAdvice"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 配置數據 - 便於維護和更新
        const FUND_CONFIG = {
            etf0050: {
                scale: 6473.76, // 6,473.76億元
                managementFeeRates: [
                    { threshold: 1000, rate: 0.15 },
                    { threshold: 5000, rate: 0.10 },
                    { threshold: 10000, rate: 0.08 },
                    { threshold: Infinity, rate: 0.05 }
                ],
                custodyFeeRates: [
                    { threshold: 10000, rate: 0.03 },
                    { threshold: Infinity, rate: 0.025 }
                ]
            },
            linkFund: {
                scale: 240, // 240億元
                managementFeeRate: 0.0075, // 5% × 0.15%
                custodyFeeRates: [
                    { threshold: 50, rate: 0.02 },
                    { threshold: 100, rate: 0.015 },
                    { threshold: Infinity, rate: 0.01 }
                ],
                bearRatio: 0.95 // 95%承擔0050費用
            },
            validation: {
                monthlyInvestment: { min: 1000, max: 100000 },
                investmentYears: { min: 1, max: 30 },
                annualReturn: { min: 0, max: 20 },
                dividendYield: { min: 0, max: 10 },
                taxableRatio: { min: 0, max: 100 }
            }
        };

        // 主計算器類別
        class FundCalculator {
            constructor(config) {
                this.config = config;
            }

            // 計算階梯式費率
            calculateTieredFee(scale, feeRates) {
                let totalFee = 0;
                let remainingScale = scale;
                let prevThreshold = 0;

                for (const tier of feeRates) {
                    const tierAmount = Math.min(remainingScale, tier.threshold - prevThreshold);
                    if (tierAmount <= 0) break;
                    
                    totalFee += tierAmount * (tier.rate / 100);
                    remainingScale -= tierAmount;
                    prevThreshold = tier.threshold;
                    
                    if (remainingScale <= 0) break;
                }

                return (totalFee / scale) * 100; // 返回百分比
            }

            // 0050 ETF 經理費
            calculate0050ManagementFee() {
                return this.calculateTieredFee(
                    this.config.etf0050.scale,
                    this.config.etf0050.managementFeeRates
                );
            }

            // 0050 ETF 保管費
            calculate0050CustodyFee() {
                const scale = this.config.etf0050.scale;
                return scale < 10000 ? 0.03 : 0.025;
            }

            // 連結基金經理費
            calculateLinkFundManagementFee() {
                return this.config.linkFund.managementFeeRate;
            }

            // 連結基金保管費
            calculateLinkFundCustodyFee() {
                return this.calculateTieredFee(
                    this.config.linkFund.scale,
                    this.config.linkFund.custodyFeeRates
                );
            }

            // 連結基金承擔0050費用
            calculateLinkFund0050Fee() {
                const etfTotalFee = this.calculate0050ManagementFee() + this.calculate0050CustodyFee();
                return this.config.linkFund.bearRatio * etfTotalFee;
            }

            // 計算累積資產（修正精度）
            calculateAccumulatedAssets(monthlyAmount, years, annualReturn) {
                const monthlyReturn = annualReturn / 100 / 12;
                const totalMonths = years * 12;
                
                if (monthlyReturn === 0) {
                    return monthlyAmount * totalMonths;
                }
                
                // 使用精確的年金現值公式
                return monthlyAmount * (Math.pow(1 + monthlyReturn, totalMonths) - 1) / monthlyReturn;
            }

            // 計算交易成本
            calculateTransactionCosts(finalAmount, monthlyAmount, years) {
                const totalMonths = years * 12;
                
                // ETF交易成本
                const etfBuyFees = 1 * totalMonths; // 每次申購1元
                const etfSellFees = finalAmount * 0.001425 * 0.28; // 手續費折扣
                const etfTax = finalAmount * 0.001; // 證交稅
                const etfTotal = etfBuyFees + etfSellFees + etfTax;
                
                // 連結基金交易成本（基富通平台免費）
                const linkTotal = 0;
                
                return {
                    etf: {
                        buyFees: etfBuyFees,
                        sellFees: etfSellFees,
                        tax: etfTax,
                        total: etfTotal
                    },
                    link: {
                        total: linkTotal
                    }
                };
            }

            // 計算股利稅務（改進版）
            calculateDividendTax(monthlyAmount, years, annualReturn, dividendYield, taxableRatio, personalTaxRate) {
                const monthlyReturn = annualReturn / 100 / 12;
                let totalDividend = 0;
                
                // 逐年計算配息
                for (let year = 1; year <= years; year++) {
                    const yearEndAssets = this.calculateAccumulatedAssets(monthlyAmount, year, annualReturn);
                    const yearDividend = yearEndAssets * dividendYield / 100;
                    totalDividend += yearDividend;
                }
                
                const totalTaxable = totalDividend * taxableRatio / 100;
                const taxOwed = totalTaxable * personalTaxRate / 100;
                const taxCredit = totalTaxable * 8.5 / 100; // 可抵減稅額
                const actualTax = Math.max(0, taxOwed - taxCredit);
                const refund = Math.max(0, taxCredit - taxOwed);
                
                return {
                    totalDividend,
                    totalTaxable,
                    taxOwed,
                    taxCredit,
                    actualTax,
                    refund
                };
            }
        }

        // 輸入驗證器
        class InputValidator {
            static validate(inputs) {
                const errors = [];
                const config = FUND_CONFIG.validation;
                
                // 檢查每月投資金額
                if (inputs.monthlyInvestment < config.monthlyInvestment.min || 
                    inputs.monthlyInvestment > config.monthlyInvestment.max) {
                    errors.push(`每月投資金額應在 ${config.monthlyInvestment.min.toLocaleString()} - ${config.monthlyInvestment.max.toLocaleString()} 元之間`);
                }
                
                // 檢查投資期間
                if (inputs.investmentYears < config.investmentYears.min || 
                    inputs.investmentYears > config.investmentYears.max) {
                    errors.push(`投資期間應在 ${config.investmentYears.min} - ${config.investmentYears.max} 年之間`);
                }
                
                // 檢查年化報酬率
                if (inputs.annualReturn < config.annualReturn.min || 
                    inputs.annualReturn > config.annualReturn.max) {
                    errors.push(`年化報酬率應在 ${config.annualReturn.min}% - ${config.annualReturn.max}% 之間`);
                }
                
                // 檢查配息率
                if (inputs.dividendYield < config.dividendYield.min || 
                    inputs.dividendYield > config.dividendYield.max) {
                    errors.push(`年配息率應在 ${config.dividendYield.min}% - ${config.dividendYield.max}% 之間`);
                }
                
                // 檢查課稅比例
                if (inputs.taxableRatio < config.taxableRatio.min || 
                    inputs.taxableRatio > config.taxableRatio.max) {
                    errors.push(`54C課稅比例應在 ${config.taxableRatio.min}% - ${config.taxableRatio.max}% 之間`);
                }
                
                // 邏輯檢查
                if (inputs.dividendYield > inputs.annualReturn) {
                    errors.push('配息率通常不應超過總報酬率，請檢查設定');
                }
                
                return errors;
            }
            
            static highlightErrors(inputs, errors) {
                // 清除之前的錯誤狀態
                document.querySelectorAll('.form-group input').forEach(input => {
                    input.classList.remove('error');
                });
                
                // 如果有錯誤，標記相關欄位
                if (errors.length > 0) {
                    const config = FUND_CONFIG.validation;
                    
                    if (inputs.monthlyInvestment < config.monthlyInvestment.min || 
                        inputs.monthlyInvestment > config.monthlyInvestment.max) {
                        document.getElementById('monthlyInvestment').classList.add('error');
                    }
                    
                    if (inputs.investmentYears < config.investmentYears.min || 
                        inputs.investmentYears > config.investmentYears.max) {
                        document.getElementById('investmentYears').classList.add('error');
                    }
                    
                    if (inputs.annualReturn < config.annualReturn.min || 
                        inputs.annualReturn > config.annualReturn.max) {
                        document.getElementById('annualReturn').classList.add('error');
                    }
                    
                    if (inputs.dividendYield < config.dividendYield.min || 
                        inputs.dividendYield > config.dividendYield.max) {
                        document.getElementById('dividendYield').classList.add('error');
                    }
                    
                    if (inputs.taxableRatio < config.taxableRatio.min || 
                        inputs.taxableRatio > config.taxableRatio.max) {
                        document.getElementById('taxableRatio').classList.add('error');
                    }
                }
            }
        }

        // UI 控制器
        class UIController {
            static showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            static hideError() {
                document.getElementById('errorMessage').style.display = 'none';
            }
            
            static showLoading() {
                const btn = document.getElementById('calculateBtn');
                const spinner = document.getElementById('loadingSpinner');
                const text = document.getElementById('btnText');
                
                btn.disabled = true;
                spinner.style.display = 'inline-block';
                text.textContent = '計算中...';
            }
            
            static hideLoading() {
                const btn = document.getElementById('calculateBtn');
                const spinner = document.getElementById('loadingSpinner');
                const text = document.getElementById('btnText');
                
                btn.disabled = false;
                spinner.style.display = 'none';
                text.textContent = '重新計算';
            }
            
            static showResults() {
                const results = document.getElementById('results');
                results.classList.add('show');
                results.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // 獲取使用者輸入
        function getInputValues() {
            return {
                monthlyInvestment: parseFloat(document.getElementById('monthlyInvestment').value) || 0,
                investmentYears: parseInt(document.getElementById('investmentYears').value) || 0,
                annualReturn: parseFloat(document.getElementById('annualReturn').value) || 0,
                dividendYield: parseFloat(document.getElementById('dividendYield').value) || 0,
                taxableRatio: parseFloat(document.getElementById('taxableRatio').value) || 0,
                personalTaxRate: parseFloat(document.getElementById('personalTaxRate').value) || 0
            };
        }

        // 主計算處理函數
        async function handleCalculation() {
            try {
                UIController.hideError();
                UIController.showLoading();
                
                // 獲取輸入值
                const inputs = getInputValues();
                
                // 驗證輸入
                const errors = InputValidator.validate(inputs);
                InputValidator.highlightErrors(inputs, errors);
                
                if (errors.length > 0) {
                    throw new Error(errors.join('、'));
                }
                
                // 模擬計算延遲（讓使用者看到載入狀態）
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 執行計算
                await calculateComparison(inputs);
                
            } catch (error) {
                UIController.showError(error.message);
            } finally {
                UIController.hideLoading();
            }
        }

        // 主要計算函數（改進版）
        async function calculateComparison(inputs) {
            const calculator = new FundCalculator(FUND_CONFIG);
            
            // 計算各種費率
            const etf0050ManagementFee = calculator.calculate0050ManagementFee();
            const etf0050CustodyFee = calculator.calculate0050CustodyFee();
            const etf0050TotalFee = etf0050ManagementFee + etf0050CustodyFee;
            
            const linkManagementFee = calculator.calculateLinkFundManagementFee();
            const linkCustodyFee = calculator.calculateLinkFundCustodyFee();
            const link0050Fee = calculator.calculateLinkFund0050Fee();
            const linkTotalFee = linkManagementFee + linkCustodyFee + link0050Fee;
            
            // 計算累積資產
            const finalAmount = calculator.calculateAccumulatedAssets(
                inputs.monthlyInvestment, 
                inputs.investmentYears, 
                inputs.annualReturn
            );
            
            // 估算平均資產（用於計算內扣費用）
            const averageAssets = finalAmount * 0.6; // 簡化估算
            
            // 計算內扣費用
            const etfInternalFees = averageAssets * etf0050TotalFee / 100;
            const linkInternalFees = averageAssets * linkTotalFee / 100;
            
            // 計算交易成本
            const transactionCosts = calculator.calculateTransactionCosts(
                finalAmount, 
                inputs.monthlyInvestment, 
                inputs.investmentYears
            );
            
            // 計算稅務
            const taxAnalysis = calculator.calculateDividendTax(
                inputs.monthlyInvestment,
                inputs.investmentYears,
                inputs.annualReturn,
                inputs.dividendYield,
                inputs.taxableRatio,
                inputs.personalTaxRate
            );
            
            // 計算總成本
            const netTaxCost = taxAnalysis.actualTax - taxAnalysis.refund;
            const etfTotalCost = etfInternalFees + transactionCosts.etf.total + netTaxCost;
            const linkTotalCost = linkInternalFees + transactionCosts.link.total;
            
            // 準備結果數據
            const results = {
                fees: {
                    etf: { 
                        management: etf0050ManagementFee, 
                        custody: etf0050CustodyFee, 
                        total: etf0050TotalFee 
                    },
                    link: { 
                        management: linkManagementFee, 
                        custody: linkCustodyFee, 
                        承擔0050費用: link0050Fee, 
                        total: linkTotalFee 
                    }
                },
                internalFees: { etf: etfInternalFees, link: linkInternalFees },
                transactionCosts: transactionCosts,
                taxAnalysis: taxAnalysis,
                totalCosts: { etf: etfTotalCost, link: linkTotalCost },
                finalAmount: finalAmount,
                inputs: inputs
            };
            
            // 顯示結果
            displayResults(results);
            UIController.showResults();
        }

        // 顯示費用規則（簡化版）
        function displayFeeRules() {
            const rulesDiv = document.getElementById('feeRules');
            rulesDiv.innerHTML = `
                <div class="rules-container">
                    <div class="rule-section">
                        <h4>🏦 0050 ETF 費用結構</h4>
                        <p><strong>基金規模：${FUND_CONFIG.etf0050.scale.toLocaleString()}億元</strong></p>
                        <h5>經理費階梯式收費：</h5>
                        <table class="fee-table">
                            <thead><tr><th>資產規模</th><th>費率</th></tr></thead>
                            <tbody>
                                <tr><td>前1,000億</td><td>0.15%</td></tr>
                                <tr><td>1,000-5,000億</td><td>0.10%</td></tr>
                                <tr><td>5,000億-1兆</td><td>0.08%</td></tr>
                                <tr><td>超過1兆</td><td>0.05%</td></tr>
                            </tbody>
                        </table>
                        <h5>保管費：</h5>
                        <p>1兆元以下：0.03%，超過1兆元：0.025%</p>
                    </div>
                    <div class="rule-section">
                        <h4>🔗 連結基金A類 費用結構</h4>
                        <p><strong>基金規模：${FUND_CONFIG.linkFund.scale}億元</strong></p>
                        <h5>經理費：</h5>
                        <p>僅對5%現金部位收取0.15%經理費</p>
                        <h5>保管費階梯式收費：</h5>
                        <table class="fee-table">
                            <thead><tr><th>資產規模</th><th>費率</th></tr></thead>
                            <tbody>
                                <tr><td>前50億</td><td>0.02%</td></tr>
                                <tr><td>50-100億</td><td>0.015%</td></tr>
                                <tr><td>超過100億</td><td>0.01%</td></tr>
                            </tbody>
                        </table>
                        <h5>承擔費用：</h5>
                        <p>95%投資部位承擔0050的經理費和保管費</p>
                    </div>
                </div>
            `;
        }

        // 折疊功能
        function toggleCollapse(elementId) {
            const content = document.getElementById(elementId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.collapse-icon');
            
            content.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }
        
        function toggleCalculationSection(sectionId) {
            const content = document.getElementById(sectionId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.collapse-icon');
            
            content.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }

        // 顯示內扣費用計算（整合表格和重點比較，添加折疊功能）
        function displayCalculationProcess(results) {
            const processDiv = document.getElementById('calculationProcess');
            const inputs = results.inputs;
            const calculator = new FundCalculator(FUND_CONFIG);
            
            // 獲取詳細計算數據
            const scale0050 = FUND_CONFIG.etf0050.scale;
            const scaleLinkFund = FUND_CONFIG.linkFund.scale;
            
            // 計算0050經理費的各階段
            const mgmtFee1 = Math.min(1000, scale0050) * 0.15 / 100;
            const mgmtFee2 = Math.min(Math.max(0, scale0050 - 1000), 4000) * 0.10 / 100;
            const mgmtFee3 = Math.min(Math.max(0, scale0050 - 5000), 5000) * 0.08 / 100;
            const mgmtFee4 = Math.max(0, scale0050 - 10000) * 0.05 / 100;
            const totalMgmtFee = mgmtFee1 + mgmtFee2 + mgmtFee3 + mgmtFee4;
            
            // 計算連結基金保管費的各階段
            const custodyFee1 = Math.min(50, scaleLinkFund) * 0.02 / 100;
            const custodyFee2 = Math.min(Math.max(0, scaleLinkFund - 50), 50) * 0.015 / 100;
            const custodyFee3 = Math.max(0, scaleLinkFund - 100) * 0.01 / 100;
            const totalLinkCustodyFee = custodyFee1 + custodyFee2 + custodyFee3;
            
            // 費用差異計算
            const feeDifference = results.internalFees.etf - results.internalFees.link;
            
            processDiv.innerHTML = `
                <div class="calculation-section">
                    <div class="calculation-section-header" onclick="toggleCalculationSection('etfCalculationContent')">
                        <h4>🏦 0050 ETF 內扣費用計算 <span class="collapse-icon">▼</span></h4>
                    </div>
                    <div id="etfCalculationContent" class="calculation-section-content">
                        <div class="calculation-step">
                            <h4>💰 經理費階梯計算</h4>
                            <div class="formula">
                                基金規模：${scale0050.toLocaleString()}億元<br><br>
                                階梯計算過程：<br>
                                • 前1,000億元 × 0.15% = ${Math.min(1000, scale0050).toLocaleString()}億 × 0.15% = ${mgmtFee1.toFixed(4)}億元<br>
                                ${scale0050 > 1000 ? `• 1,000-5,000億元 × 0.10% = ${Math.min(Math.max(0, scale0050 - 1000), 4000).toLocaleString()}億 × 0.10% = ${mgmtFee2.toFixed(4)}億元<br>` : ''}
                                ${scale0050 > 5000 ? `• 5,000-10,000億元 × 0.08% = ${Math.min(Math.max(0, scale0050 - 5000), 5000).toLocaleString()}億 × 0.08% = ${mgmtFee3.toFixed(4)}億元<br>` : ''}
                                ${scale0050 > 10000 ? `• 超過10,000億元 × 0.05% = ${Math.max(0, scale0050 - 10000).toLocaleString()}億 × 0.05% = ${mgmtFee4.toFixed(4)}億元<br>` : ''}
                                <br>
                                總經理費 = ${mgmtFee1.toFixed(4)} + ${mgmtFee2.toFixed(4)} + ${mgmtFee3.toFixed(4)} + ${mgmtFee4.toFixed(4)} = ${totalMgmtFee.toFixed(4)}億元
                            </div>
                            <div class="step-result">
                                經理費率 = ${totalMgmtFee.toFixed(4)}億 ÷ ${scale0050.toLocaleString()}億 × 100% = ${results.fees.etf.management.toFixed(6)}%
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>🏛️ 保管費計算</h4>
                            <div class="formula">
                                基金規模：${scale0050.toLocaleString()}億元<br>
                                適用規則：${scale0050 < 10000 ? '未達1兆元，適用0.03%' : '已達1兆元，適用0.025%'}
                            </div>
                            <div class="step-result">
                                保管費率 = ${results.fees.etf.custody.toFixed(3)}%
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="calculation-section">
                    <div class="calculation-section-header" onclick="toggleCalculationSection('linkFundCalculationContent')">
                        <h4>🔗 連結基金A類 內扣費用計算 <span class="collapse-icon">▼</span></h4>
                    </div>
                    <div id="linkFundCalculationContent" class="calculation-section-content">
                        <div class="calculation-step">
                            <h4>💰 經理費計算</h4>
                            <div class="formula">
                                投資策略：<br>
                                • 95%投資0050：不收取經理費<br>
                                • 5%現金部位：按0050經理費規則收取<br><br>
                                
                                計算過程：<br>
                                現金部位經理費 = 5% × 0.15% = 0.0075%<br>
                                （0.15%為0050在前1,000億適用的費率）
                            </div>
                            <div class="step-result">
                                經理費率 = ${results.fees.link.management.toFixed(4)}%
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>🏛️ 保管費階梯計算</h4>
                            <div class="formula">
                                基金規模：${scaleLinkFund}億元<br><br>
                                階梯計算過程：<br>
                                • 前50億元 × 0.02% = ${Math.min(50, scaleLinkFund)}億 × 0.02% = ${custodyFee1.toFixed(6)}億元<br>
                                ${scaleLinkFund > 50 ? `• 50-100億元 × 0.015% = ${Math.min(Math.max(0, scaleLinkFund - 50), 50)}億 × 0.015% = ${custodyFee2.toFixed(6)}億元<br>` : ''}
                                ${scaleLinkFund > 100 ? `• 超過100億元 × 0.01% = ${Math.max(0, scaleLinkFund - 100)}億 × 0.01% = ${custodyFee3.toFixed(6)}億元<br>` : ''}
                                <br>
                                總保管費 = ${custodyFee1.toFixed(6)} + ${custodyFee2.toFixed(6)} + ${custodyFee3.toFixed(6)} = ${totalLinkCustodyFee.toFixed(6)}億元
                            </div>
                            <div class="step-result">
                                保管費率 = ${totalLinkCustodyFee.toFixed(6)}億 ÷ ${scaleLinkFund}億 × 100% = ${results.fees.link.custody.toFixed(6)}%
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>💼 承擔0050費用計算</h4>
                            <div class="formula">
                                0050總費用率 = ${results.fees.etf.management.toFixed(6)}% + ${results.fees.etf.custody.toFixed(3)}% = ${results.fees.etf.total.toFixed(6)}%<br><br>
                                
                                連結基金承擔費用：<br>
                                承擔比例 × 0050總費用率<br>
                                = 95% × ${results.fees.etf.total.toFixed(6)}% = ${results.fees.link.承擔0050費用.toFixed(6)}%
                            </div>
                            <div class="step-result">
                                承擔0050費用：${results.fees.link.承擔0050費用.toFixed(6)}%
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 30px 0;">
                    <h4 class="collapsible-header" onclick="toggleCollapse('feeStructureContent')" style="color: #2c3e50; margin: 0 0 20px 0; font-size: 1.4em; border-bottom: 3px solid #3498db; padding-bottom: 10px; cursor: pointer; user-select: none; position: relative; padding-right: 30px;">
                        💰 費用結構分析 <span class="collapse-icon">▼</span>
                    </h4>
                    <div id="feeStructureContent" class="collapsible-content">
                        <div class="table-container">
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th>費用項目</th>
                                        <th>0050 ETF</th>
                                        <th>連結基金A類</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>經理費</td>
                                        <td>${results.fees.etf.management.toFixed(4)}%</td>
                                        <td>${results.fees.link.management.toFixed(4)}%</td>
                                    </tr>
                                    <tr>
                                        <td>保管費</td>
                                        <td>${results.fees.etf.custody.toFixed(3)}%</td>
                                        <td>${results.fees.link.custody.toFixed(4)}%</td>
                                    </tr>
                                    <tr>
                                        <td>承擔0050費用</td>
                                        <td>-</td>
                                        <td>${results.fees.link.承擔0050費用.toFixed(4)}%</td>
                                    </tr>
                                    <tr style="font-weight: bold; background: #f8f9fa;">
                                        <td>總費用率</td>
                                        <td>${results.fees.etf.total.toFixed(4)}%</td>
                                        <td class="${results.fees.link.total < results.fees.etf.total ? 'winner' : ''}">${results.fees.link.total.toFixed(4)}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 30px 0;">
                    <h4 style="color: #2c3e50; margin: 0 0 20px 0; font-size: 1.4em; border-bottom: 3px solid #3498db; padding-bottom: 10px;">🎯 總內扣費用比較</h4>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin: 20px 0;">
                        <div class="grid-2-cols" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: center;">
                            <div style="text-align: center;">
                                <h4 style="color: white; margin: 0 0 15px 0; font-size: 1.3em;">🏦 0050 ETF</h4>
                                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">年費用率</div>
                                    <div style="font-size: 2.2em; font-weight: bold; color: #4caf50;">${results.fees.etf.total.toFixed(4)}%</div>
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <h4 style="color: white; margin: 0 0 15px 0; font-size: 1.3em;">🔗 連結基金A類</h4>
                                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">年費用率</div>
                                    <div style="font-size: 2.2em; font-weight: bold; color: #e74c3c;">${results.fees.link.total.toFixed(4)}%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 25px; padding-top: 25px; border-top: 2px solid rgba(255,255,255,0.3);">
                            <div style="font-size: 1.1em; margin-bottom: 10px;">💰 年費用率差異</div>
                            <div style="font-size: 2.5em; font-weight: bold; color: #e74c3c;">
                                ${(results.fees.etf.total - results.fees.link.total).toFixed(4)}%
                            </div>
                            <div style="font-size: 1em; opacity: 0.9; margin-top: 8px;">
                                ${results.fees.etf.total > results.fees.link.total ? 
                                    '連結基金A類費用率較低' :
                                    '0050 ETF費用率較低'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 顯示交易成本詳細計算（整合表格並添加折疊功能）
        function displayTransactionCostsCalculation(results) {
            const calculationDiv = document.getElementById('transactionCostsCalculation');
            const inputs = results.inputs;
            const totalMonths = inputs.investmentYears * 12;
            
            calculationDiv.innerHTML = `
                <div class="calculation-section">
                    <div class="calculation-section-header" onclick="toggleCalculationSection('investmentRulesContent')">
                        <h4>📋 定期定額投資規則說明 <span class="collapse-icon">▼</span></h4>
                    </div>
                    <div id="investmentRulesContent" class="calculation-section-content">
                        <div class="calculation-step">
                            <h4>🔄 定期定額投資假設</h4>
                            <div class="formula">
                                投資方式設定：<br>
                                • 每月固定投資：${inputs.monthlyInvestment.toLocaleString()}元<br>
                                • 投資期間：${inputs.investmentYears}年（共${totalMonths}個月）<br>
                                • 投資頻率：每月1次，固定日期扣款<br>
                                • 期末一次性贖回：第${inputs.investmentYears}年底全額贖回<br><br>
                                
                                0050 ETF 交易規則：<br>
                                • 申購平台：券商平台（如富邦、國泰等）<br>
                                • 申購手續費：每次1元（定期定額優惠）<br>
                                • 贖回手續費：0.1425% × 28折（網路下單優惠）<br>
                                • 證交稅：賣出金額 × 0.1%<br><br>
                                
                                連結基金A類 交易規則：<br>
                                • 申購平台：基富通平台<br>
                                • 申購手續費：完全免費<br>
                                • 贖回手續費：完全免費<br>
                                • 證交稅：基金類型免稅
                            </div>
                            <div class="step-result">
                                以上規則為實際投資時的一般情況，實際費用請以各平台公告為準
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>📈 累積資產計算邏輯</h4>
                            <div class="formula">
                                定期定額複利計算公式：<br>
                                FV = PMT × [(1 + r)^n - 1] / r<br><br>
                                
                                參數設定：<br>
                                • PMT（每月投資）= ${inputs.monthlyInvestment.toLocaleString()}元<br>
                                • r（月報酬率）= ${inputs.annualReturn}% ÷ 12 = ${(inputs.annualReturn/12).toFixed(4)}%<br>
                                • n（總投資月數）= ${inputs.investmentYears}年 × 12 = ${totalMonths}個月<br><br>
                                
                                計算過程：<br>
                                ${inputs.annualReturn === 0 ? 
                                    `無利息情況：${inputs.monthlyInvestment.toLocaleString()} × ${totalMonths} = ${Math.round(inputs.monthlyInvestment * totalMonths).toLocaleString()}元` :
                                    `FV = ${inputs.monthlyInvestment.toLocaleString()} × [(1 + ${(inputs.annualReturn/12/100).toFixed(6)})^${totalMonths} - 1] / ${(inputs.annualReturn/12/100).toFixed(6)}<br>
                                    FV = ${inputs.monthlyInvestment.toLocaleString()} × ${((Math.pow(1 + inputs.annualReturn/100/12, totalMonths) - 1) / (inputs.annualReturn/100/12)).toFixed(4)}`
                                }
                            </div>
                            <div class="step-result">
                                ${inputs.investmentYears}年後累積資產（贖回金額）：${Math.round(results.finalAmount).toLocaleString()}元<br>
                                此金額將作為後續交易成本計算的基礎
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="calculation-section">
                    <div class="calculation-section-header" onclick="toggleCalculationSection('etfTransactionContent')">
                        <h4>🏦 0050 ETF 交易成本詳細計算 <span class="collapse-icon">▼</span></h4>
                    </div>
                    <div id="etfTransactionContent" class="calculation-section-content">
                        <div class="calculation-step">
                            <h4>💸 申購手續費計算</h4>
                            <div class="formula">
                                計算過程：<br>
                                總申購手續費 = 1元/次 × ${totalMonths}次 = ${Math.round(results.transactionCosts.etf.buyFees)}元
                            </div>
                            <div class="step-result">
                                申購手續費：${Math.round(results.transactionCosts.etf.buyFees)}元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>💸 贖回手續費計算</h4>
                            <div class="formula">
                                贖回金額：${Math.round(results.finalAmount).toLocaleString()}元<br>
                                券商手續費率：0.1425%<br>
                                優惠折扣：28折（多數券商網路下單優惠）<br><br>
                                
                                計算過程：<br>
                                贖回手續費 = ${Math.round(results.finalAmount).toLocaleString()}元 × 0.1425% × 28% = ${Math.round(results.transactionCosts.etf.sellFees)}元
                            </div>
                            <div class="step-result">
                                贖回手續費：${Math.round(results.transactionCosts.etf.sellFees)}元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>💸 證交稅計算</h4>
                            <div class="formula">
                                贖回金額：${Math.round(results.finalAmount).toLocaleString()}元<br>
                                證交稅率：0.1%（ETF賣出時課徵）<br><br>
                                
                                計算過程：<br>
                                證交稅 = ${Math.round(results.finalAmount).toLocaleString()}元 × 0.1% = ${Math.round(results.transactionCosts.etf.tax)}元
                            </div>
                            <div class="step-result">
                                證交稅：${Math.round(results.transactionCosts.etf.tax)}元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>📊 0050 ETF 交易成本總計</h4>
                            <div class="formula">
                                總交易成本 = 申購手續費 + 贖回手續費 + 證交稅<br>
                                = ${Math.round(results.transactionCosts.etf.buyFees)}元 + ${Math.round(results.transactionCosts.etf.sellFees)}元 + ${Math.round(results.transactionCosts.etf.tax)}元
                            </div>
                            <div class="step-result">
                                0050 ETF 總交易成本：${Math.round(results.transactionCosts.etf.total)}元
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="calculation-section">
                    <div class="calculation-section-header" onclick="toggleCalculationSection('linkFundTransactionContent')">
                        <h4>🔗 連結基金A類 交易成本詳細計算 <span class="collapse-icon">▼</span></h4>
                    </div>
                    <div id="linkFundTransactionContent" class="calculation-section-content">
                        <div class="calculation-step">
                            <h4>💸 申購手續費計算</h4>
                            <div class="formula">
                                基富通平台優惠：<br>
                                • 定期定額申購：免手續費<br>
                                • 單筆申購：免手續費<br>
                                • 平台補貼：完全免費
                            </div>
                            <div class="step-result">
                                申購手續費：0元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>💸 贖回手續費計算</h4>
                            <div class="formula">
                                基富通平台優惠：<br>
                                • 基金贖回：免手續費<br>
                                • 無最低金額限制<br>
                                • 平台補貼：完全免費
                            </div>
                            <div class="step-result">
                                贖回手續費：0元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>💸 證交稅計算</h4>
                            <div class="formula">
                                基金類型特性：<br>
                                • 基金受益憑證：免證交稅<br>
                                • 非股票類商品：不適用證交稅<br>
                                • 法規豁免：完全免稅
                            </div>
                            <div class="step-result">
                                證交稅：0元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>📊 連結基金A類 交易成本總計</h4>
                            <div class="formula">
                                總交易成本 = 申購手續費 + 贖回手續費 + 證交稅<br>
                                = 0元 + 0元 + 0元
                            </div>
                            <div class="step-result">
                                連結基金A類 總交易成本：0元
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 30px 0;">
                    <h4 class="collapsible-header" onclick="toggleCollapse('transactionCostTableContent')" style="color: #2c3e50; margin: 0 0 20px 0; font-size: 1.4em; border-bottom: 3px solid #e74c3c; padding-bottom: 10px; cursor: pointer; user-select: none; position: relative; padding-right: 30px;">
                        💸 交易成本比較表格 <span class="collapse-icon">▼</span>
                    </h4>
                    <div id="transactionCostTableContent" class="collapsible-content">
                        <div class="table-container">
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th>成本項目</th>
                                        <th>0050 ETF</th>
                                        <th>連結基金A類</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>申購手續費</td>
                                        <td>${Math.round(results.transactionCosts.etf.buyFees).toLocaleString()}元</td>
                                        <td>0元</td>
                                    </tr>
                                    <tr>
                                        <td>贖回手續費</td>
                                        <td>${Math.round(results.transactionCosts.etf.sellFees).toLocaleString()}元</td>
                                        <td>0元</td>
                                    </tr>
                                    <tr>
                                        <td>證交稅</td>
                                        <td>${Math.round(results.transactionCosts.etf.tax).toLocaleString()}元</td>
                                        <td>0元</td>
                                    </tr>
                                    <tr style="font-weight: bold; background: #f8f9fa;">
                                        <td>總交易成本</td>
                                        <td>${Math.round(results.transactionCosts.etf.total).toLocaleString()}元</td>
                                        <td>0元</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 30px 0;">
                    <h4 style="color: #2c3e50; margin: 0 0 20px 0; font-size: 1.4em; border-bottom: 3px solid #e74c3c; padding-bottom: 10px;">🎯 交易成本重點比較</h4>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin: 20px 0;">
                        <div class="grid-2-cols" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: center;">
                            <div style="text-align: center;">
                                <h4 style="color: white; margin: 0 0 15px 0; font-size: 1.3em;">🏦 0050 ETF</h4>
                                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">${results.inputs.investmentYears}年總交易成本</div>
                                    <div style="font-size: 2.2em; font-weight: bold; color: #ffeb3b;">${Math.round(results.transactionCosts.etf.total).toLocaleString()}元</div>
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <h4 style="color: white; margin: 0 0 15px 0; font-size: 1.3em;">🔗 連結基金A類</h4>
                                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">${results.inputs.investmentYears}年總交易成本</div>
                                    <div style="font-size: 2.2em; font-weight: bold; color: #4caf50;">0元</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 25px; padding-top: 25px; border-top: 2px solid rgba(255,255,255,0.3);">
                            <div style="font-size: 1.1em; margin-bottom: 10px;">💰 交易成本差異</div>
                            <div style="font-size: 2.5em; font-weight: bold; color: #4caf50;">
                                ${Math.round(results.transactionCosts.etf.total).toLocaleString()}元
                            </div>
                            <div style="font-size: 1em; opacity: 0.9; margin-top: 8px;">
                                選擇連結基金A類可節省交易成本
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 顯示稅務成本詳細計算
        function displayTaxCostsCalculation(results) {
            const calculationDiv = document.getElementById('taxCostsCalculation');
            const inputs = results.inputs;
            const netTaxCost = results.taxAnalysis.actualTax - results.taxAnalysis.refund;
            
            calculationDiv.innerHTML = `
                <div class="calculation-section">
                    <div class="calculation-section-header" onclick="toggleCalculationSection('etfTaxCalculationContent')">
                        <h4>🏦 0050 ETF 稅務成本詳細計算 <span class="collapse-icon">▼</span></h4>
                    </div>
                    <div id="etfTaxCalculationContent" class="calculation-section-content">
                        <div class="calculation-step">
                            <h4>🧾 配息金額估算</h4>
                            <div class="formula">
                                投資參數：<br>
                                • 年配息率：${inputs.dividendYield}%<br>
                                • 投資期間：${inputs.investmentYears}年<br>
                                • 累積資產變化：隨投資時間遞增<br><br>
                                
                                計算邏輯：<br>
                                每年根據當年底累積資產計算配息<br>
                                總配息 = Σ(各年度資產 × 年配息率)
                            </div>
                            <div class="step-result">
                                ${inputs.investmentYears}年總配息：${Math.round(results.taxAnalysis.totalDividend).toLocaleString()}元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>🧾 54C課稅金額計算</h4>
                            <div class="formula">
                                課稅規則（54C條款）：<br>
                                • 總配息金額：${Math.round(results.taxAnalysis.totalDividend).toLocaleString()}元<br>
                                • 54C課稅比例：${inputs.taxableRatio}%<br>
                                • 免稅部分：${100 - inputs.taxableRatio}%<br><br>
                                
                                計算過程：<br>
                                需課稅金額 = ${Math.round(results.taxAnalysis.totalDividend).toLocaleString()}元 × ${inputs.taxableRatio}% = ${Math.round(results.taxAnalysis.totalTaxable).toLocaleString()}元
                            </div>
                            <div class="step-result">
                                課稅金額：${Math.round(results.taxAnalysis.totalTaxable).toLocaleString()}元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>🧾 應納稅額計算</h4>
                            <div class="formula">
                                個人綜合所得稅：<br>
                                • 課稅金額：${Math.round(results.taxAnalysis.totalTaxable).toLocaleString()}元<br>
                                • 適用稅率：${inputs.personalTaxRate}%<br>
                                • 計算基礎：併入年度綜合所得<br><br>
                                
                                計算過程：<br>
                                應納稅額 = ${Math.round(results.taxAnalysis.totalTaxable).toLocaleString()}元 × ${inputs.personalTaxRate}% = ${Math.round(results.taxAnalysis.taxOwed).toLocaleString()}元
                            </div>
                            <div class="step-result">
                                應納稅額：${Math.round(results.taxAnalysis.taxOwed).toLocaleString()}元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>🧾 可抵減稅額計算</h4>
                            <div class="formula">
                                股利稅額扣抵：<br>
                                • 課稅金額：${Math.round(results.taxAnalysis.totalTaxable).toLocaleString()}元<br>
                                • 抵減稅額率：8.5%<br>
                                • 上限：8萬元/年（個人）<br><br>
                                
                                計算過程：<br>
                                可抵減稅額 = ${Math.round(results.taxAnalysis.totalTaxable).toLocaleString()}元 × 8.5% = ${Math.round(results.taxAnalysis.taxCredit).toLocaleString()}元
                            </div>
                            <div class="step-result">
                                可抵減稅額：${Math.round(results.taxAnalysis.taxCredit).toLocaleString()}元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>🧾 實際稅負計算</h4>
                            <div class="formula">
                                最終稅負：<br>
                                • 應納稅額：${Math.round(results.taxAnalysis.taxOwed).toLocaleString()}元<br>
                                • 可抵減稅額：${Math.round(results.taxAnalysis.taxCredit).toLocaleString()}元<br><br>
                                
                                計算過程：<br>
                                實際稅負 = 應納稅額 - 可抵減稅額<br>
                                = ${Math.round(results.taxAnalysis.taxOwed).toLocaleString()}元 - ${Math.round(results.taxAnalysis.taxCredit).toLocaleString()}元 = ${Math.round(netTaxCost).toLocaleString()}元
                                ${results.taxAnalysis.refund > 0 ? `<br><br>※ 可抵減稅額超過應納稅額，可退稅：${Math.round(results.taxAnalysis.refund).toLocaleString()}元` : ''}
                            </div>
                            <div class="step-result">
                                實際稅負：${netTaxCost >= 0 ? Math.round(netTaxCost).toLocaleString() + '元' : '退稅' + Math.round(-netTaxCost).toLocaleString() + '元'}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="calculation-section">
                    <div class="calculation-section-header" onclick="toggleCalculationSection('linkTaxCalculationContent')">
                        <h4>🔗 連結基金A類 稅務成本詳細計算 <span class="collapse-icon">▼</span></h4>
                    </div>
                    <div id="linkTaxCalculationContent" class="calculation-section-content">
                        <div class="calculation-step">
                            <h4>🧾 基金類型特性</h4>
                            <div class="formula">
                                累積型基金特性：<br>
                                • 不進行配息：將收益自動再投資<br>
                                • 複利成長：收益轉為基金淨值增長<br>
                                • 無股利所得：不產生應稅所得<br>
                                • 資本利得：持有期間免稅
                            </div>
                            <div class="step-result">
                                投資期間稅務負擔：0元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>🧾 贖回時稅務處理</h4>
                            <div class="formula">
                                贖回時稅務：<br>
                                • 基金交易所得：目前免課證所稅<br>
                                • 無最低稅負：一般投資人適用<br>
                                • 無二代健保：基金交易免課<br>
                                • 完全免稅：無任何稅務負擔
                            </div>
                            <div class="step-result">
                                贖回時稅務負擔：0元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>📊 連結基金A類 稅務成本總計</h4>
                            <div class="formula">
                                總稅務成本 = 投資期間稅負 + 贖回時稅負<br>
                                = 0元 + 0元
                            </div>
                            <div class="step-result">
                                連結基金A類 總稅務成本：0元
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 30px 0;">
                    <h4 class="collapsible-header" onclick="toggleCollapse('taxCostTableContent')" style="color: #2c3e50; margin: 0 0 20px 0; font-size: 1.4em; border-bottom: 3px solid #f39c12; padding-bottom: 10px; cursor: pointer; user-select: none; position: relative; padding-right: 30px;">
                        🧾 稅務成本比較表格 <span class="collapse-icon">▼</span>
                    </h4>
                    <div id="taxCostTableContent" class="collapsible-content">
                        <div class="table-container">
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th>稅務項目</th>
                                        <th>0050 ETF</th>
                                        <th>連結基金A類</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>總配息金額</td>
                                        <td>${Math.round(results.taxAnalysis.totalDividend).toLocaleString()}元</td>
                                        <td>0元（無配息）</td>
                                    </tr>
                                    <tr>
                                        <td>需課稅金額</td>
                                        <td>${Math.round(results.taxAnalysis.totalTaxable).toLocaleString()}元</td>
                                        <td>0元</td>
                                    </tr>
                                    <tr>
                                        <td>應納稅額</td>
                                        <td>${Math.round(results.taxAnalysis.taxOwed).toLocaleString()}元</td>
                                        <td>0元</td>
                                    </tr>
                                    <tr>
                                        <td>可抵減稅額</td>
                                        <td>${Math.round(results.taxAnalysis.taxCredit).toLocaleString()}元</td>
                                        <td>0元</td>
                                    </tr>
                                    <tr style="font-weight: bold; background: #f8f9fa;">
                                        <td>實際稅務成本</td>
                                        <td>${(results.taxAnalysis.actualTax - results.taxAnalysis.refund) >= 0 ? Math.round(results.taxAnalysis.actualTax - results.taxAnalysis.refund).toLocaleString() + '元' : '退稅' + Math.round(-(results.taxAnalysis.actualTax - results.taxAnalysis.refund)).toLocaleString() + '元'}</td>
                                        <td>0元</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 30px 0;">
                    <h4 style="color: #2c3e50; margin: 0 0 20px 0; font-size: 1.4em; border-bottom: 3px solid #f39c12; padding-bottom: 10px;">🎯 稅務成本差異分析</h4>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin: 20px 0;">
                        <div class="grid-2-cols" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: center;">
                            <div style="text-align: center;">
                                <h4 style="color: white; margin: 0 0 15px 0; font-size: 1.3em;">🏦 0050 ETF</h4>
                                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">${results.inputs.investmentYears}年總稅務成本</div>
                                    <div style="font-size: 2.2em; font-weight: bold; color: ${netTaxCost >= 0 ? '#ffeb3b' : '#4caf50'};">
                                        ${netTaxCost >= 0 ? Math.round(netTaxCost).toLocaleString() + '元' : '退稅' + Math.round(-netTaxCost).toLocaleString() + '元'}
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <h4 style="color: white; margin: 0 0 15px 0; font-size: 1.3em;">🔗 連結基金A類</h4>
                                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">${results.inputs.investmentYears}年總稅務成本</div>
                                    <div style="font-size: 2.2em; font-weight: bold; color: #4caf50;">0元</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 25px; padding-top: 25px; border-top: 2px solid rgba(255,255,255,0.3);">
                            <div style="font-size: 1.1em; margin-bottom: 10px;">💰 稅務成本差異</div>
                            <div style="font-size: 2.5em; font-weight: bold; color: ${netTaxCost >= 0 ? '#4caf50' : '#ffeb3b'};">
                                ${netTaxCost >= 0 ? Math.round(netTaxCost).toLocaleString() + '元' : Math.round(-netTaxCost).toLocaleString() + '元'}
                            </div>
                            <div style="font-size: 1em; opacity: 0.9; margin-top: 8px;">
                                ${netTaxCost >= 0 ? 
                                    '選擇連結基金A類可節省稅務成本' :
                                    '0050 ETF有退稅優勢'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 顯示結果（主函數）
        function displayResults(results) {
            displayFeeRules();
            displayCalculationProcess(results);
            displayTransactionCostsCalculation(results);
            displayTaxCostsCalculation(results);
            
            // 填充其他表格數據
            fillTotalComparison(results);
            fillInvestmentAdvice(results);
        }

        // 填充總成本比較
        function fillTotalComparison(results) {
            const totalDiv = document.getElementById('totalComparison');
            if (!totalDiv) return;
            
            const savings = results.totalCosts.etf - results.totalCosts.link;
            const averageAssets = results.finalAmount * 0.6; // 簡化估算
            
            totalDiv.innerHTML = `
                <div class="calculation-section">
                    <div class="calculation-section-header" onclick="toggleCalculationSection('internalFeesMethodContent')">
                        <h4>💰 內扣費用計算方式說明 <span class="collapse-icon">▼</span></h4>
                    </div>
                    <div id="internalFeesMethodContent" class="calculation-section-content">
                        <div class="calculation-step">
                            <h4>📈 平均資產估算</h4>
                            <div class="formula">
                                計算邏輯：<br>
                                • 最終資產：${Math.round(results.finalAmount).toLocaleString()}元<br>
                                • 估算係數：60%（簡化估算，考慮定期定額特性）<br>
                                • 計算原理：定期定額投資過程中，資產逐步累積，平均持有資產約為最終資產的60%<br><br>
                                
                                平均資產 = 最終資產 × 60%<br>
                                = ${Math.round(results.finalAmount).toLocaleString()}元 × 60% = ${Math.round(averageAssets).toLocaleString()}元
                            </div>
                            <div class="step-result">
                                用於計算內扣費用的平均資產：${Math.round(averageAssets).toLocaleString()}元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>🏦 0050 ETF 內扣費用計算</h4>
                            <div class="formula">
                                計算過程：<br>
                                • 平均資產：${Math.round(averageAssets).toLocaleString()}元<br>
                                • 總費用率：${results.fees.etf.total.toFixed(4)}%<br>
                                • 投資期間：${results.inputs.investmentYears}年<br><br>
                                
                                內扣費用 = 平均資產 × 總費用率 × 投資期間<br>
                                = ${Math.round(averageAssets).toLocaleString()}元 × ${results.fees.etf.total.toFixed(4)}% × ${results.inputs.investmentYears}年<br>
                                = ${Math.round(results.internalFees.etf).toLocaleString()}元
                            </div>
                            <div class="step-result">
                                0050 ETF ${results.inputs.investmentYears}年總內扣費用：${Math.round(results.internalFees.etf).toLocaleString()}元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>🔗 連結基金A類 內扣費用計算</h4>
                            <div class="formula">
                                計算過程：<br>
                                • 平均資產：${Math.round(averageAssets).toLocaleString()}元<br>
                                • 總費用率：${results.fees.link.total.toFixed(4)}%<br>
                                • 投資期間：${results.inputs.investmentYears}年<br><br>
                                
                                內扣費用 = 平均資產 × 總費用率 × 投資期間<br>
                                = ${Math.round(averageAssets).toLocaleString()}元 × ${results.fees.link.total.toFixed(4)}% × ${results.inputs.investmentYears}年<br>
                                = ${Math.round(results.internalFees.link).toLocaleString()}元
                            </div>
                            <div class="step-result">
                                連結基金A類 ${results.inputs.investmentYears}年總內扣費用：${Math.round(results.internalFees.link).toLocaleString()}元
                            </div>
                        </div>
                        
                        <div class="calculation-step">
                            <h4>📊 內扣費用差異</h4>
                            <div class="formula">
                                費用差異計算：<br>
                                內扣費用差異 = 0050 ETF內扣費用 - 連結基金A類內扣費用<br>
                                = ${Math.round(results.internalFees.etf).toLocaleString()}元 - ${Math.round(results.internalFees.link).toLocaleString()}元<br>
                                = ${Math.round(results.internalFees.etf - results.internalFees.link).toLocaleString()}元
                            </div>
                            <div class="step-result">
                                ${results.internalFees.etf > results.internalFees.link ? 
                                    `選擇連結基金A類可節省內扣費用：${Math.round(results.internalFees.etf - results.internalFees.link).toLocaleString()}元` :
                                    `選擇0050 ETF可節省內扣費用：${Math.round(results.internalFees.link - results.internalFees.etf).toLocaleString()}元`
                                }
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 30px 0;">
                    <h4 style="color: #2c3e50; margin: 0 0 20px 0; font-size: 1.4em; border-bottom: 3px solid #3498db; padding-bottom: 10px;">📋 總成本詳細比較</h4>
                    <div class="table-container">
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>成本項目</th>
                                    <th>0050 ETF</th>
                                    <th>連結基金A類</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>內扣費用</td>
                                    <td>${Math.round(results.internalFees.etf).toLocaleString()}元</td>
                                    <td>${Math.round(results.internalFees.link).toLocaleString()}元</td>
                                </tr>
                                <tr>
                                    <td>交易成本</td>
                                    <td>${Math.round(results.transactionCosts.etf.total).toLocaleString()}元</td>
                                    <td>0元</td>
                                </tr>
                                <tr>
                                    <td>稅務成本</td>
                                    <td>${Math.round(results.taxAnalysis.actualTax - results.taxAnalysis.refund).toLocaleString()}元</td>
                                    <td>0元</td>
                                </tr>
                                <tr style="font-weight: bold; font-size: 1.1em; background: #f8f9fa;">
                                    <td>總成本</td>
                                    <td class="${savings > 0 ? 'negative' : 'winner'}">${Math.round(results.totalCosts.etf).toLocaleString()}元</td>
                                    <td class="${savings > 0 ? 'winner' : 'negative'}">${Math.round(results.totalCosts.link).toLocaleString()}元</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="highlight">
                    ${savings > 0 ? 
                        `選擇連結基金A類可節省：<span class="positive">${Math.round(savings).toLocaleString()}元</span><br>節省比例：<span class="positive">${(savings/results.totalCosts.etf*100).toFixed(1)}%</span>` :
                        `選擇0050 ETF可節省：<span class="positive">${Math.round(-savings).toLocaleString()}元</span><br>節省比例：<span class="positive">${(-savings/results.totalCosts.link*100).toFixed(1)}%</span>`
                    }
                </div>
            `;
        }

        // 填充投資建議
        function fillInvestmentAdvice(results) {
            const adviceDiv = document.getElementById('investmentAdvice');
            if (!adviceDiv) return;
            
            const savings = results.totalCosts.etf - results.totalCosts.link;
            let recommendation = '';
            
            if (savings > 1000) {
                recommendation = `
                    <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: #155724; margin-top: 0;">📈 強烈建議選擇連結基金A類</h4>
                        <p>可節省 <strong>${Math.round(savings).toLocaleString()}元</strong>，節省效果顯著。</p>
                    </div>
                `;
            } else if (savings > 0) {
                recommendation = `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: #856404; margin-top: 0;">⚖️ 建議選擇連結基金A類</h4>
                        <p>可節省 <strong>${Math.round(savings).toLocaleString()}元</strong>。</p>
                    </div>
                `;
            } else if (savings < -1000) {
                recommendation = `
                    <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: #155724; margin-top: 0;">📊 強烈建議選擇0050 ETF</h4>
                        <p>可節省 <strong>${Math.round(-savings).toLocaleString()}元</strong>，節省效果顯著。</p>
                    </div>
                `;
            } else {
                recommendation = `
                    <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: #721c24; margin-top: 0;">⚖️ 兩者成本相當</h4>
                        <p>可依個人偏好選擇，差異較小。</p>
                    </div>
                `;
            }
            
            adviceDiv.innerHTML = recommendation + `
                <h4>💡 關鍵考量因素：</h4>
                <ul style="line-height: 1.8;">
                    <li><strong>投資金額：</strong>每月${results.inputs.monthlyInvestment.toLocaleString()}元，${results.inputs.monthlyInvestment <= 5000 ? '適合連結基金的小額投資優勢' : '兩種產品都適合'}</li>
                    <li><strong>稅率影響：</strong>${results.inputs.personalTaxRate}%稅率${results.inputs.personalTaxRate >= 12 ? '，連結基金免稅優勢明顯' : '，稅務優勢有限'}</li>
                    <li><strong>配息偏好：</strong>0050提供${results.inputs.dividendYield}%現金配息，連結基金採累積複利</li>
                    <li><strong>投資便利性：</strong>連結基金交易更便利，無需證券帳戶</li>
                    <li><strong>投資期間：</strong>${results.inputs.investmentYears}年投資期間${results.inputs.investmentYears >= 10 ? '較長，內扣費用差異會放大' : '，短期差異較小'}</li>
                </ul>
            `;
        }

        // 添加即時驗證
        document.addEventListener('DOMContentLoaded', function() {
            // 為所有輸入欄位添加即時驗證
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', function() {
                    this.classList.remove('error');
                    UIController.hideError();
                });
                
                input.addEventListener('blur', function() {
                    const inputs = getInputValues();
                    const errors = InputValidator.validate(inputs);
                    InputValidator.highlightErrors(inputs, errors);
                });
            });
            
            // 初始計算
            handleCalculation();
        });

    </script>
</body>
</html>
